<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>車メーカー</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-size: 18px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .item {
            width: 150px;
            text-align: center;
        }
        .image-container {
            position: relative;
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            text-align: center;
            line-height: 150px;
            margin-bottom: 10px;
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            position: relative;
            z-index: 1;
        }
        .image-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px dashed gray;
            box-sizing: border-box;
            pointer-events: none;
        }
        .image-container textarea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
        }
        .color-sample {
            display: inline-block;
            width: 50px;
            height: 20px;
            margin-left: 10px;
            border: 1px solid #000;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 20px;
        }
        #warning {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>車メーカー5</h1>
    <p>このページを使って、ニコ生ゲームの投稿ファイル（game.zip）を簡単に作成できます。</p>
    <h2>使い方</h2>
    <ol>
        <li>表示されている画像にドラッグ＆ドロップまたはペーストで新しい画像に変更します。</li>
        <li>変更した内容を含むZIPファイルをダウンロードボタンを押してダウンロードします。</li>
        <li>ダウンロードしたファイルをニコ生ゲームとして投稿します。</li>
    </ol>
    <p>※画像はPNG形式で、幅と高さが10ピクセル以上500ピクセル以下である必要があります。</p>

    <div class="container">
        <div class="item">
            <h3>画像変更</h3>
            <div class="image-container">
                <img id="car" src="game/files/car.png" alt="car">
                <textarea></textarea>
            </div>
            <p>車体 ： 200x100</p>
        </div>
        <div class="item">
            <h3>画像変更</h3>
            <div class="image-container">
                <img id="tire" src="game/files/tire.png" alt="tire">
                <textarea></textarea>
            </div>
            <p>タイヤ ： 50x50</p>
        </div>
        <div class="item">
            <h3>画像変更</h3>
            <div class="image-container">
                <img id="ki" src="game/files/ki.png" alt="ki">
                <textarea></textarea>
            </div>
            <p>木 ： 80x200</p>
        </div>
        <div class="item">
            <h3>画像変更</h3>
            <div class="image-container">
                <img id="sabo" src="game/files/sabo.png" alt="sabo">
                <textarea></textarea>
            </div>
            <p>サボテン： 100x150</p>
        </div>
    </div>

    <p>背景、地面、文字の色を変更できます。</p>
    <p>初期カラー</p> 　

    <p>背景：<span class="color-sample" id="bgColorSample"></span></p>
    <p>地面：<span class="color-sample" id="floorColorSample"></span></p>
    <p>文字：<span class="color-sample" id="textColorSample"></span></p>

    <h2>色の変更</h2>
    <label for="bgColor">背景色:</label>
    <input type="color" id="bgColor" name="bgColor" value="#0F5474"><br>
    <label for="floorColor">地面色:</label>
    <input type="color" id="floorColor" name="floorColor" value="#977609"><br>
    <label for="textColor">文字色:</label>
    <input type="color" id="textColor" name="textColor" value="white"><br>

    <button id="downloadZip">game.zip をダウンロード</button>
    <div id="warning"></div>
<script>
    const images = {
        "car": "game/files/car.png",
        "tire": "game/files/tire.png",
        "ki": "game/files/ki.png",
        "sabo": "game/files/sabo.png"
    };
    const audioFiles = [
        "game/files/bgm.aac",
        "game/files/bgm.ogg",
        "game/files/on.aac",
        "game/files/on.ogg",
        "game/files/off.aac",
        "game/files/off.ogg"
    ];
    let colors = {
        "bgColor": "#0F5474",
        "floorColor": "#977609",
        "textColor": "#FFFFFF"
    };
    document.querySelectorAll('.image-container div').forEach(div => {
        div.addEventListener('dragover', event => event.preventDefault());
        div.addEventListener('drop', handleDrop);
        div.querySelector('textarea').addEventListener('paste', handlePaste);
    });
    async function loadGameJson() {
        const response = await fetch('game/game.json');
        return await response.json();
    }
    async function loadColorJson() {
        const response = await fetch('game/files/color.json');
        colors = await response.json();
        document.getElementById('bgColor').value = colors.bgColor;
        document.getElementById('floorColor').value = colors.floorColor;
        document.getElementById('textColor').value = colors.textColor;
        updateColorSamples();
    }
    function updateColorSamples() {
        document.getElementById('bgColorSample').style.backgroundColor = colors.bgColor;
        document.getElementById('floorColorSample').style.backgroundColor = colors.floorColor;
        document.getElementById('textColorSample').style.backgroundColor = colors.textColor;
    }
    function handleDrop(event) {
        event.preventDefault();
        const file = event.dataTransfer.files[0];
        processFile(file, event.currentTarget.querySelector('img'));
    }
    function handlePaste(event) {
        const items = event.clipboardData.items;
        const target = event.currentTarget.parentNode.querySelector('img');
        if (target) {
            for (let item of items) {
                if (item.kind === 'file') {
                    const file = item.getAsFile();
                    processFile(file, target);
                }
            }
        }
    }
    function processFile(file, target) {
        const warningDiv = document.getElementById('warning');
        warningDiv.textContent = '';
        if (!file.type.startsWith('image/png')) {
            warningDiv.textContent = 'エラー：サポートされている画像形式はPNGのみです。';
            return;
        }
        const img = new Image();
        img.onload = function() {
            if (img.width < 10 || img.width > 500 || img.height < 10 || img.height > 500) {
                warningDiv.textContent = 'エラー：画像の寸法は10x10から500x500ピクセルの間である必要があります。';
                return;
            }
            updateImage(target, img.src);
        };
        img.onerror = function() {
            warningDiv.textContent = 'エラー：無効な画像ファイルです。';
        };
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    function updateImage(target, dataUrl) {
        target.src = dataUrl;
        const assetKey = target.id;
        images[assetKey] = dataUrl;
    }
    document.getElementById('downloadZip').addEventListener('click', async () => {
        const zip = new JSZip();
        const gameJson = await loadGameJson();
        Object.keys(images).forEach(key => {
            gameJson.assets[key].path = `files/${key}.png`;
            const imgElement = document.getElementById(key);
            gameJson.assets[key].width = imgElement.naturalWidth;
            gameJson.assets[key].height = imgElement.naturalHeight;
        });
        Object.keys(colors).forEach(key => {
            colors[key] = document.getElementById(key).value;
        });
        zip.file("game.json", JSON.stringify(gameJson, null, 2));
        zip.file("files/color.json", JSON.stringify(colors, null, 2));
        const fetchPromises = Object.keys(images).map(async key => {
            const imgDataUrl = images[key];
            const blob = await fetch(imgDataUrl).then(res => res.blob());
            zip.file(`files/${key}.png`, blob);
        });
        audioFiles.forEach(filePath => {
            fetchPromises.push((async () => {
                const response = await fetch(filePath);
                const blob = await response.blob();
                zip.file(`files/${filePath.split('/').pop()}`, blob);
            })());
        });
        await Promise.all(fetchPromises);
        zip.generateAsync({ type: "blob" }).then(content => {
            saveAs(content, "game.zip");
        });
    });
    loadColorJson();
</script>

</body>
</html>
